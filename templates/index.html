<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #43aa8b;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --chart-height: 400px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        .completed-tickets-header {
            background: #4361ee;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .completed-tickets-header .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .completed-tickets-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .completed-tickets-header .header-count {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .users-container {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-card {
            border-bottom: 1px solid #eee;
        }
        
        .user-card:last-child {
            border-bottom: none;
        }
        
        .user-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .user-header:hover {
            background: #f8f9fa;
        }
        
        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .user-count {
            color: #6c757d;
            font-size: 14px;
        }
        
        .toggle-icon {
            transition: transform 0.3s;
        }
        
        .user-issues {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .user-issues.active {
            max-height: none;
            overflow: visible;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--gray-color);
            font-size: 16px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: var(--transition);
            height: calc(var(--chart-height) + 80px);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            height: 40px;
        }
        
        .card-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .card-body {
            position: relative;
            height: var(--chart-height);
        }
        
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        /* Priority tags */
        .priority-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
            color: white;
        }
        
        .priority-minimal { background: #6c757d; }
        .priority-low { background: #20c997; }
        .priority-medium { background: #0d6efd; }
        .priority-high { background: #fd7e14; }
        .priority-urgent { background: #dc3545; }
        .priority-emergency { background: #6f42c1; }
        
        /* Status tag */
        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(108, 117, 125, 0.1);
            color: var(--gray-color);
        }
        
        /* Issues list */
        .issues-container {
            transition: height 0.3s ease;
            overflow: hidden;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .issues-header {
            padding: 16px 20px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .issues-header:hover {
            background: var(--secondary-color);
        }
        
        .issues-header-title {
            font-weight: 500;
            font-size: 16px;
        }
        
        .issues-header-count {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .issues-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .issues-list {
            list-style: none;
            padding: 15px 20px;
        }
        
        .issue-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .issue-item:last-child {
            border-bottom: none;
        }
        
        .issue-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-right: 8px;
            transition: var(--transition);
        }
        
        .issue-link:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }
        
        .issue-subject {
            margin: 5px 0;
        }
        
        .issue-assignee {
            font-size: 13px;
            color: var(--gray-color);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ */
        .open-tickets-header {
            background: #f72585; /* –î—Ä—É–≥–æ–π —Ü–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∏—á–∏—è */
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .open-tickets-header .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .open-tickets-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .open-tickets-header .header-count {
            font-size: 14px;
            opacity: 0.9;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ */
        .project-section {
            border-bottom: 1px solid #eee;
        }

        .project-section:last-child {
            border-bottom: none;
        }

        .project-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8f9fa;
        }

        .project-header:hover {
            background-color: #e9ecef;
        }

        .project-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .project-name {
            font-weight: 500;
            color: var(--primary-color);
        }

        .project-count {
            color: var(--gray-color);
            font-size: 14px;
        }

        .project-issues {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: white;
        }

        .project-issues.active {
            max-height: 1000px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .card {
                padding: 15px;
                height: calc(var(--chart-height) + 60px);
            }
            
            .card-title {
                font-size: 16px;
            }
            
            :root {
                --chart-height: 350px;
            }
        }
        
        @media (max-width: 480px) {
            :root {
                --chart-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> –ù–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤</h1>
            <p>–û–±–∑–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</p>
        </header>
        
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–ó–∞–∫—Ä—ã—Ç—ã–µ –∏ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–µ —Ç–∏–∫–µ—Ç—ã</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ticket-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–û—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ticket3-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="completed-tickets-header" style="background: #f72585;">
            <div class="header-title">
                <i class="fas fa-exclamation-circle"></i>
                <h2>–û—Ç–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</h2>
            </div>
            <div class="header-count">–í—Å–µ–≥–æ: {{ issues_current_open|length }}</div>
        </div>
        
        <div class="users-container" style="margin-bottom: 20px;">
            <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º -->
            {% set projects = {} %}
            {% for issue in issues_current_open %}
                {% if issue.project.name not in projects %}
                    {% set _ = projects.update({issue.project.name: []}) %}
                {% endif %}
                {% set _ = projects[issue.project.name].append(issue) %}
            {% endfor %}
            
            <!-- –í—ã–≤–æ–¥ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∏—Ö —Ç–∏–∫–µ—Ç–æ–≤ -->
            {% for project_name, project_issues in projects.items() %}
            <div class="user-card">
                <div class="user-header" onclick="toggleUserIssues(this, 'project-{{ loop.index }}')">
                    <div class="user-info">
                        <span class="user-name">{{ project_name }}</span>
                        <span class="user-count">{{ project_issues|length }} —Ç–∏–∫–µ—Ç–æ–≤</span>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                
                <div class="user-issues" id="project-{{ loop.index }}">
                    <ul class="issues-list">
                        {% for issue in project_issues %}
                        <li class="issue-item">
                            <a href="https://helpdesk.fenix-it.ru/issues/{{issue.id}}" target="_blank" class="issue-link">#{{issue.id}}</a>
                            
                            {% if issue.priority == 4 %}
                                <span class="priority-tag priority-minimal">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π</span>
                            {% endif %}
                            {% if issue.priority == 1 %}
                                <span class="priority-tag priority-low">–ù–∏–∑–∫–∏–π</span>
                            {% endif %}
                            {% if issue.priority == 2 %}
                                <span class="priority-tag priority-medium">–°—Ä–µ–¥–Ω–∏–π</span>
                            {% endif %}
                            {% if issue.priority == 3 %}
                                <span class="priority-tag priority-high">–í—ã—Å–æ–∫–∏–π</span>
                            {% endif %}
                            {% if issue.priority == 5 %}
                                <span class="priority-tag priority-urgent">–ù–∞–∏–≤—ã—Å—à–∏–π</span>
                            {% endif %}
                            {% if issue.priority == 11 %}
                                <span class="priority-tag priority-emergency">–ê–≤–∞—Ä–∏–π–Ω—ã–π</span>
                            {% endif %}
                            
                            <span class="status-tag">{{ issue.status }}</span>
                            
                            <div class="issue-subject">{{issue.subject}}</div>
                            <div class="issue-assignee">–ù–∞–∑–Ω–∞—á–µ–Ω–∞: <strong>{{issue.assigned_to}}</strong></div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤</h2>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="ticket6-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ticket2-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (—á–∞—Å—ã)</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ticket4-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–¢–∏–∫–µ—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ticket5-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç—ã" -->
        <div class="completed-tickets-header">
            <div class="header-title">
                <i class="fas fa-check-circle"></i>
                <h2>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç—ã</h2>
            </div>
            <div class="header-count">–í—Å–µ–≥–æ: {{issues|length}}</div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞–¥–∞—á–∞–º–∏ -->
        <div class="users-container">
            {% for user in users %}
            <div class="user-card">
                <div class="user-header" onclick="toggleUserIssues(this, 'user-{{user.id}}')">
                    <div class="user-info">
                        <span class="user-name">{{user.lastname}} {{user.firstname}}</span>
                        <span class="user-count">{{user.count_tickets}} —Ç–∏–∫–µ—Ç–æ–≤</span>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                
                <div class="user-issues" id="user-{{user.id}}">
                    <ul class="issues-list">
                        {% for issue in issues %}
                            {% for custom_field in issue['custom_fields'] %}
                                {% if custom_field.name == "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" %}
                                    {% if custom_field.value == user.id|string %}
                                    <li class="issue-item">
                                        <a href="https://helpdesk.fenix-it.ru/issues/{{issue.id}}" target="_blank" class="issue-link">#{{issue.id}}</a>
                                        
                                        {% if issue.priority == 4 %}
                                            <span class="priority-tag priority-minimal">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π</span>
                                        {% endif %}
                                        {% if issue.priority == 1 %}
                                            <span class="priority-tag priority-low">–ù–∏–∑–∫–∏–π</span>
                                        {% endif %}
                                        {% if issue.priority == 2 %}
                                            <span class="priority-tag priority-medium">–°—Ä–µ–¥–Ω–∏–π</span>
                                        {% endif %}
                                        {% if issue.priority == 3 %}
                                            <span class="priority-tag priority-high">–í—ã—Å–æ–∫–∏–π</span>
                                        {% endif %}
                                        {% if issue.priority == 5 %}
                                            <span class="priority-tag priority-urgent">–ù–∞–∏–≤—ã—Å—à–∏–π</span>
                                        {% endif %}
                                        {% if issue.priority == 11 %}
                                            <span class="priority-tag priority-emergency">–ê–≤–∞—Ä–∏–π–Ω—ã–π</span>
                                        {% endif %}
                                        
                                        <div class="issue-subject">{{issue.subject}}</div>
                                    </li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
    <div id="draw-mode-btn" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; background:#4361ee; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:20px; cursor:pointer; z-index:9998; box-shadow:0 2px 10px rgba(0,0,0,0.2); user-select:none;">
        ‚úèÔ∏è
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div id="draw-tools" style="display:none; position:fixed; bottom:80px; right:20px; background:white; border-radius:12px; padding:10px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:9999;">
        <div style="display:flex; gap:8px; margin-bottom:10px;">
            <button data-color="#4361ee" style="width:25px; height:25px; border-radius:50%; background:#4361ee; border:none; cursor:pointer;"></button>
            <button data-color="#f72585" style="width:25px; height:25px; border-radius:50%; background:#f72585; border:none; cursor:pointer;"></button>
            <button data-color="#4cc9f0" style="width:25px; height:25px; border-radius:50%; background:#4cc9f0; border:none; cursor:pointer;"></button>
            <button data-color="#3a0ca3" style="width:25px; height:25px; border-radius:50%; background:#3a0ca3; border:none; cursor:pointer;"></button>
            <button data-color="#43aa8b" style="width:25px; height:25px; border-radius:50%; background:#43aa8b; border:none; cursor:pointer;"></button>
        </div>
        <div style="display:flex; gap:8px;">
            <button data-size="3" style="width:30px; height:25px; border-radius:4px; background:#eee; border:1px solid #ddd; cursor:pointer;">3</button>
            <button data-size="8" style="width:30px; height:25px; border-radius:4px; background:#eee; border:1px solid #ddd; cursor:pointer;">8</button>
            <button data-size="15" style="width:30px; height:25px; border-radius:4px; background:#eee; border:1px solid #ddd; cursor:pointer;">15</button>
        </div>
        <button id="clear-drawing" style="margin-top:10px; padding:5px 10px; background:#f72585; color:white; border:none; border-radius:4px; width:100%; cursor:pointer;">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>

        // Toggle issues visibility
        function toggleIssues(id) {
            const content = document.getElementById(id);
            content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
        }

        function toggleUserIssues(header, id) {
            const content = document.getElementById(id);
            if (content.classList.contains('active')) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
            content.classList.toggle('active');
            
            const icon = header.querySelector('.toggle-icon');
            icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
        }

        function toggleProjectIssues(header, id) {
            const content = document.getElementById(id);
            content.classList.toggle('active');
            
            const icon = header.querySelector('.toggle-icon');
            icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
        }

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ –∑–∞–¥–∞—á
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.user-issues').forEach(el => {
                el.classList.remove('active');
            });
        });

        // Chart data and configurations
        const issueses = {{ issues_closed + issues_open_count }};
        const ticketsClosed = {{ tickets_closed }};
        const usersData = {{ users | tojson }};
        const issuesStatuses = {{ issues_per_open | tojson }};
        const ticketsDataOnWeek = {{ tickets_data_on_week | tojson }};
        
        // Helper function to generate random colors
        function getChartColor(opacity = 1) {
            const colors = [
                '#4361ee', '#3f37c9', '#4895ef', '#4cc9f0', 
                '#f72585', '#b5179e', '#7209b7', '#560bad',
                '#480ca8', '#3a0ca3', '#3f37c9', '#4361ee',
                '#4895ef', '#4cc9f0', '#4895ef', '#4361ee'
            ];
            return colors;
        }
        
        // Chart 1: Pie chart for closed and received tickets
        new Chart(
            document.getElementById('ticket-chart').getContext('2d'),
            {
                type: 'doughnut',
                data: {
                    labels: ['–ü–æ—Å—Ç—É–ø–∏–≤—à–∏–µ —Ç–∏–∫–µ—Ç—ã', '–ó–∞–∫—Ä—ã—Ç—ã–µ —Ç–∏–∫–µ—Ç—ã'],
                    datasets: [{
                        data: [issueses, ticketsClosed],
                        backgroundColor: ['#4cc9f0', '#4361ee'],
                        borderWidth: 2,
                        datalabels: {
                            anchor: 'end'
                    }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            backgroundColor: function(context) {
                                return context.dataset.backgroundColor;
                            },
                            borderColor: 'white',
                            borderRadius: 25,
                            borderWidth: 2,
                            color: 'white',
                            display: function(context) {
                                var dataset = context.dataset;
                                var count = dataset.data.length;
                                var value = dataset.data[context.dataIndex];
                                return value > count * 1.5;
                            },
                            font: {
                                weight: 'bold'
                            },
                            padding: 6
                        },
                    },
                    cutout: '70%',
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                },
                plugins: [ChartDataLabels]
            }
        );

        const verticalCtx2 = document.getElementById('ticket2-chart').getContext('2d');
        verticalCtx2.canvas.classList.add('bar-chart-vertical');
        
        // Chart 2: Bar chart for tickets per user
        new Chart(
            document.getElementById('ticket2-chart').getContext('2d'),
            {
                type: 'bar',
                data: {
                    labels: usersData.map(user => `${user.lastname} ${user.firstname}`),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤',
                        data: usersData.map(user => user.count_tickets),
                        backgroundColor: getChartColor(0.7),
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end', // –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ—Ç–æ–∫ –∫ —Ç–æ—á–∫–µ (–Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü –∏–ª–∏ —Ü–µ–Ω—Ç—Ä)
                            align: function(context) {
                                return context.dataset.data[context.dataIndex] <= 1 ? 'top' : 'bottom';
                            },
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: function(context) {
                                // –ß—ë—Ä–Ω—ã–π –¥–ª—è 1, –±–µ–ª—ã–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                                return context.dataset.data[context.dataIndex] <= 1 ? '#777777' : '#ffffff';
                            },
                            font: {
                                weight: 'bold'
                            },
                            formatter: Math.round, // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                            padding: 6, // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –º–µ—Ç–∫–∏
                        },
                        legend: {
                            display: false  // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4  // —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
                        }
                    }
                },
                plugins: [ChartDataLabels]
            }
        );

        const verticalCtx3 = document.getElementById('ticket3-chart').getContext('2d');
        verticalCtx3.canvas.classList.add('bar-chart-vertical');
        
        // Chart 3: Bar chart for open tickets by status
        new Chart(
            document.getElementById('ticket3-chart').getContext('2d'),
            {
                type: 'bar',
                data: {
                    labels: Object.keys(issuesStatuses),
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤',
                        data: Object.values(issuesStatuses),
                        backgroundColor: getChartColor(0.7),
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end', // –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ—Ç–æ–∫ –∫ —Ç–æ—á–∫–µ (–Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü –∏–ª–∏ —Ü–µ–Ω—Ç—Ä)
                            align: function(context) {
                                return context.dataset.data[context.dataIndex] <= 5 ? 'top' : 'bottom';
                            },
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: function(context) {
                                // –ß—ë—Ä–Ω—ã–π –¥–ª—è 1, –±–µ–ª—ã–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                                return context.dataset.data[context.dataIndex] <= 5 ? '#777777' : '#ffffff';
                            },
                            font: {
                                weight: 'bold'
                            },
                            formatter: Math.round, // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                            padding: 6, // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –º–µ—Ç–∫–∏
                        },
                        legend: {
                            display: false  // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4  // —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
                        }
                    }
                },
                plugins: [ChartDataLabels]
            }
        );

        const horizontalCtx4 = document.getElementById('ticket4-chart').getContext('2d');
        horizontalCtx4.canvas.classList.add('bar-chart-horizontal');
        
        // Chart 4: Horizontal bar chart for time spent
        new Chart(
            document.getElementById('ticket4-chart').getContext('2d'),
            {
                type: 'bar',
                data: {
                    labels: usersData.map(user => `${user.lastname} ${user.firstname}`),
                    datasets: [{
                        label: '–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (—á–∞—Å—ã)',
                        data: usersData.map(user => parseFloat(user.time_entries.toFixed(2))),
                        backgroundColor: getChartColor(0.7),
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end', // –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ—Ç–æ–∫ –∫ —Ç–æ—á–∫–µ (–Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü –∏–ª–∏ —Ü–µ–Ω—Ç—Ä)
                            align: function(context) {
                                return context.dataset.data[context.dataIndex] <= 3 ? 'right' : 'left';
                            },
                        }
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: function(context) {
                                // –ß—ë—Ä–Ω—ã–π –¥–ª—è 1, –±–µ–ª—ã–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                                return context.dataset.data[context.dataIndex] <= 3 ? '#777777' : '#ffffff';
                            },
                            font: {
                                weight: 'bold' // –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç
                            },
                            padding: 6, // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –º–µ—Ç–∫–∏
                        },
                        legend: {
                            display: false  // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4  // —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
                        }
                    }
                },
                plugins: [ChartDataLabels]
            }
        );

        const verticalCtx5 = document.getElementById('ticket5-chart').getContext('2d');
        verticalCtx5.canvas.classList.add('bar-chart-vertical');
        
        // Chart 5: Bar chart for current tickets
        new Chart(
            document.getElementById('ticket5-chart').getContext('2d'),
            {
                type: 'bar',
                data: {
                    labels: usersData.map(user => `${user.lastname} ${user.firstname}`),
                    datasets: [{
                        label: '–¢–∏–∫–µ—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ',
                        data: usersData.map(user => user.current_tickets_count),
                        backgroundColor: getChartColor(0.7),
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end', // –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ—Ç–æ–∫ –∫ —Ç–æ—á–∫–µ (–Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü –∏–ª–∏ —Ü–µ–Ω—Ç—Ä)
                            align: function(context) {
                                return context.dataset.data[context.dataIndex] <= 1 ? 'top' : 'bottom';
                            },
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: function(context) {
                                // –ß—ë—Ä–Ω—ã–π –¥–ª—è 1, –±–µ–ª—ã–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                                return context.dataset.data[context.dataIndex] <= 1 ? '#777777' : '#ffffff';
                            },
                            font: {
                                weight: 'bold' // –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç
                            },
                            formatter: Math.round, // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                            padding: 6, // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –º–µ—Ç–∫–∏
                        },
                        legend: {
                            display: false  // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 24,
                            right: 16,
                            bottom: 0,
                            left: 8
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 4  // —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
                        }
                    }
                },
                plugins: [ChartDataLabels]
            }
        );

        const verticalCtx6 = document.getElementById('ticket6-chart').getContext('2d');
        verticalCtx6.canvas.classList.add('bar-chart-vertical');
        
        // Chart 6: Line chart for tickets dynamics
        const weekDays = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"];
        const weekData = weekDays.map(day => ticketsDataOnWeek[day] || 0);
        
        new Chart(
            document.getElementById('ticket6-chart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: weekDays,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–∫–µ—Ç–æ–≤',
                        data: weekData,
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderColor: '#4361ee',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#4361ee',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        datalabels: {
                            align: 'center', // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –º–µ—Ç–æ–∫ (–Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü –∏–ª–∏ —Ü–µ–Ω—Ç—Ä)
                            anchor: 'end' // –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ—Ç–æ–∫ –∫ —Ç–æ—á–∫–µ (–Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü –∏–ª–∏ —Ü–µ–Ω—Ç—Ä)
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            backgroundColor: function(context) {
                                return context.dataset.borderColor; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∏–∑ –¥–∞—Ç–∞—Å–µ—Ç–∞
                            },
                            borderRadius: 4, // –ó–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ —Ñ–æ–Ω–∞ –º–µ—Ç–∫–∏
                            color: 'white', // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –º–µ—Ç–∫–∏
                            font: {
                                weight: 'bold' // –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç
                            },
                            formatter: Math.round, // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
                            padding: 6, // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –º–µ—Ç–∫–∏
                            display: function(context) {
                                return context.dataset.data[context.dataIndex] > 0; // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                            }
                        },
                        legend: {
                            display: false  // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true, // –°—Ç–µ–∫–∞–µ–º—ã–µ –æ—Å–∏ Y (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 32,
                            right: 16,
                            bottom: 16,
                            left: 8
                        }
                    },
                    elements: {
                        line: {
                            fill: false,
                            tension: 0.4
                        }
                    }
                },
                plugins: [ChartDataLabels]
            }
        );

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        let isDrawing = false;
        let currentColor = '#4361ee';
        let currentSize = 5;
        let paths = [];
        let currentPath = [];
        let canvas, ctx;
        let scrollY = window.scrollY;

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const drawBtn = document.getElementById('draw-mode-btn');
        const drawTools = document.getElementById('draw-tools');
        const clearBtn = document.getElementById('clear-drawing');

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        drawBtn.addEventListener('click', function() {
            if (canvas) {
                // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
                document.body.removeChild(canvas);
                canvas = null;
                drawTools.style.display = 'none';
                drawBtn.innerHTML = '‚úèÔ∏è';
                drawBtn.style.backgroundColor = '#4361ee';
                document.body.style.cursor = '';
            } else {
                // –ê–∫—Ç–∏–≤–∞—Ü–∏—è
                createCanvas();
                drawTools.style.display = 'block';
                drawBtn.innerHTML = 'üö´';
                drawBtn.style.backgroundColor = '#f72585';
                document.body.style.cursor = 'crosshair';
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ canvas –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞
        function createCanvas() {
            canvas = document.createElement('canvas');
            canvas.style.position = 'absolute'; // –ò–∑–º–µ–Ω–µ–Ω–æ —Å fixed –Ω–∞ absolute
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = document.documentElement.scrollHeight + 'px'; // –ü–æ–ª–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            canvas.style.zIndex = '9997';
            canvas.style.pointerEvents = 'none';
            canvas.width = window.innerWidth;
            canvas.height = document.documentElement.scrollHeight;
            
            document.body.appendChild(canvas);
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ä–∏—Å—É–Ω–∫–∞
        clearBtn.addEventListener('click', function() {
            if (canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                paths = [];
            }
        });

        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
        document.querySelectorAll('[data-color]').forEach(btn => {
            btn.addEventListener('click', function() {
                currentColor = this.getAttribute('data-color');
            });
        });

        // –í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞
        document.querySelectorAll('[data-size]').forEach(btn => {
            btn.addEventListener('click', function() {
                currentSize = parseInt(this.getAttribute('data-size'));
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Å–∫—Ä–æ–ª–ª–∞
        window.addEventListener('mousedown', startDrawing);
        window.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', stopDrawing);
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('scroll', handleScroll);

        function startDrawing(e) {
            if (!canvas) return;
            
            isDrawing = true;
            currentPath = [{
                x: e.clientX,
                y: e.clientY + scrollY, // –£—á–∏—Ç—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
                color: currentColor,
                size: currentSize
            }];
            paths.push(currentPath);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –ø—É—Ç—å
            ctx.beginPath();
            ctx.moveTo(e.clientX, e.clientY + scrollY);
            ctx.lineWidth = currentSize;
            ctx.strokeStyle = currentColor;
        }

        function draw(e) {
            if (!isDrawing || !canvas) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å —Å —É—á–µ—Ç–æ–º —Å–∫—Ä–æ–ª–ª–∞
            currentPath.push({
                x: e.clientX,
                y: e.clientY + scrollY,
                color: currentColor,
                size: currentSize
            });
            
            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é
            ctx.lineTo(e.clientX, e.clientY + scrollY);
            ctx.stroke();
        }

        function stopDrawing() {
            if (!canvas) return;
            isDrawing = false;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
        function handleScroll() {
            scrollY = window.scrollY;
            if (canvas) {
                // –ü—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º canvas —Å –Ω–æ–≤—ã–º offset
                redrawAllPaths();
            }
        }

        // –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        function resizeCanvas() {
            if (!canvas) return;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å—É–Ω–æ–∫
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // –ò–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä canvas
            canvas.width = window.innerWidth;
            canvas.height = document.documentElement.scrollHeight;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∏—Å—É–Ω–æ–∫
            ctx.putImageData(imageData, 0, 0);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –ø—É—Ç–∏
            redrawAllPaths();
        }

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π
        function redrawAllPaths() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            paths.forEach(path => {
                if (path.length === 0) return;
                
                ctx.beginPath();
                ctx.moveTo(path[0].x, path[0].y);
                ctx.lineWidth = path[0].size;
                ctx.strokeStyle = path[0].color;
                
                for (let i = 1; i < path.length; i++) {
                    ctx.lineTo(path[i].x, path[i].y);
                    ctx.lineWidth = path[i].size;
                    ctx.strokeStyle = path[i].color;
                }
                
                ctx.stroke();
            });
        }

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        window.addEventListener('touchstart', handleTouchStart, {passive: false});
        window.addEventListener('touchmove', handleTouchMove, {passive: false});
        window.addEventListener('touchend', handleTouchEnd);

        function handleTouchStart(e) {
            if (!canvas) return;
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            startDrawing(mouseEvent);
        }

        function handleTouchMove(e) {
            if (!canvas) return;
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            draw(mouseEvent);
        }

        function handleTouchEnd() {
            if (!canvas) return;
            const mouseEvent = new MouseEvent('mouseup');
            stopDrawing(mouseEvent);
        }
    </script>

</body>
</html>